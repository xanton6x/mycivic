<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Civic Rating - Admin Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-secondary-bg-color, #f0f2f5);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1c1e21);
            --sub-text: var(--tg-theme-hint-color, #65676b);
            --border-color: var(--tg-theme-section-separator-color, #ddd);
            --input-bg: var(--tg-theme-secondary-bg-color, #f5f6f7);
            --star-color: #ccc; --star-active: #f39c12;
            --primary: var(--tg-theme-button-color, #1877f2);
        }

        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 20px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px; position: relative; box-sizing: border-box; }
        
        .profile-container { position: relative; width: 120px; height: 120px; margin: -60px auto 15px; }
        .car-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 5px solid var(--card-bg); }
        .change-pic-btn { position: absolute; bottom: 5px; right: 5px; background: #42b72a; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 10; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 15px; align-items: center; margin-bottom: 20px; }
        .average-score { font-size: 3.5rem; font-weight: 800; color: var(--star-active); margin: 0; }
        .dist-bar-container { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-bottom: 4px; }
        .dist-bar-bg { flex: 1; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; }
        .dist-bar-fill { height: 100%; background: var(--star-active); width: 0%; transition: 0.5s; }

        .star-rating { display: flex; justify-content: center; gap: 8px; margin: 15px 0; font-size: 35px; direction: ltr; }
        .star-rating span { color: var(--star-color); cursor: pointer; transition: 0.2s; }
        .star-rating span.active { color: var(--star-active); animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; justify-content: center; }
        .tag-chip { background: var(--input-bg); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; }
        
        textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); box-sizing: border-box; font-size: 16px; outline: none; resize: none; }

        .review-card { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 1px solid transparent; }
        .review-card.pinned { border: 2px solid gold; background: linear-gradient(to bottom, var(--card-bg), #fffdf0); }
        .pinned-badge { color: gold; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: none; }
        .review-card.pinned .pinned-badge { display: block; }

        .admin-controls { display: flex; gap: 10px; position: absolute; top: -40px; left: 0; }
        .admin-btn { background: var(--card-bg); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 18px; color: var(--text-color); }
        
        .action-btns { display: flex; gap: 5px; margin-top: 10px; display: none; }
        .admin-active .action-btns { display: flex; }
        .small-btn { font-size: 0.7rem; padding: 3px 7px; border-radius: 5px; border: none; cursor: pointer; color: white; }
    </style>
</head>
<body class="">

<div class="container" id="mainContainer">
    <div class="admin-controls">
        <button class="admin-btn" onclick="adminLogin()">ğŸ”‘</button>
        <button id="lockBtn" class="admin-btn" style="display:none;" onclick="toggleLock()">ğŸ”“</button>
    </div>

    <div class="profile-container">
        <img id="carImage" src="https://via.placeholder.com/150" class="car-pic">
        <button id="changePicBtn" class="change-pic-btn" onclick="changeCarImage()">ğŸ“·</button>
    </div>

    <div id="lockMessage" style="display:none; text-align:center; color:red; font-weight:bold; margin-bottom:15px;">ğŸ”’ ×”×“×™×¨×•×’ ×¡×’×•×¨ ×›×¨×’×¢.</div>

    <div class="stats-grid">
        <div style="text-align: center;">
            <p class="average-score" id="avgScore">0.0</p>
            <div id="avgStars" style="color:var(--star-active)"></div>
            <p id="totalReviews" style="font-size:0.75rem; color:var(--sub-text)"></p>
        </div>
        <div id="distribution"></div>
    </div>

    <div id="inputArea">
        <div id="welcomeMsg" style="text-align:center; font-weight:bold; margin-bottom:5px;"></div>
        <div class="star-rating" id="starInput">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <div class="tags-container" id="tagsList"></div>
        <button id="editTagsBtn" class="small-btn" style="background:gray; display:none; margin: -10px auto 10px;" onclick="editTags()">âœï¸ ×¢×¨×•×š ×ª×’×™×•×ª</button>
        <textarea id="carComment" rows="3" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
    </div>
</div>

<div id="reviews" style="width:100%; max-width:500px; margin-top:25px;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCiBOPWWSgKlz0IHVvTt4jktfHLI1hsYQc",
        authDomain: "mycivic-11af8.firebaseapp.com",
        databaseURL: "https://mycivic-11af8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mycivic-11af8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    let isAdmin = false, selectedRating = 0, isLocked = false;
    const user = tg.initDataUnsafe?.user;
    const userName = user ? `${user.first_name} ${user.last_name || ""}` : "××•×¨×—";
    document.getElementById('welcomeMsg').innerText = `×”×™×™ ${userName}, ×“×¨×’ ××•×ª×™:`;

    // --- Listeners ---
    onValue(ref(db, 'reviews'), (s) => renderReviews(s.val()));
    onValue(ref(db, 'config'), (s) => {
        const conf = s.val() || {};
        if (conf.carImageUrl) document.getElementById('carImage').src = conf.carImageUrl;
        isLocked = conf.isLocked || false;
        handleLockUI();
        renderTags(conf.tags || ['ğŸš€ ××˜×•×¡!', 'ğŸ”¥ ×”×¦×’×”', 'ğŸ”Š ×¡××•× ×“', 'ğŸ’ ×©××•×¨×”']);
    });

    function handleLockUI() {
        document.getElementById('lockBtn').innerText = isLocked ? "ğŸ”’" : "ğŸ”“";
        document.getElementById('lockMessage').style.display = isLocked ? "block" : "none";
        document.getElementById('inputArea').style.opacity = isLocked ? "0.3" : "1";
        document.getElementById('inputArea').style.pointerEvents = isLocked ? "none" : "all";
        isLocked ? tg.MainButton.hide() : tg.MainButton.show();
    }

    // --- Admin Actions ---
    window.adminLogin = () => {
        if(prompt("×¡×™×¡××”:") === "1234") {
            isAdmin = true;
            document.body.classList.add('admin-active');
            document.getElementById('changePicBtn').style.display = 'flex';
            document.getElementById('lockBtn').style.display = 'block';
            document.getElementById('editTagsBtn').style.display = 'block';
            renderReviews(null); // Refresh to show buttons
            tg.showAlert("××¦×‘ ×× ×”×œ ×¤×¢×™×œ");
        }
    };

    window.toggleLock = () => {
        set(ref(db, 'config/isLocked'), !isLocked);
    };

    window.editTags = () => {
        const newTags = prompt("×”×›× ×¡ ×ª×’×™×•×ª ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§:");
        if (newTags) set(ref(db, 'config/tags'), newTags.split(',').map(t => t.trim()));
    };

    window.pinReview = (id, currentStatus) => {
        update(ref(db, `reviews/${id}`), { pinned: !currentStatus });
    };

    window.editReview = (id, oldText) => {
        const newText = prompt("×¢×¨×•×š ×ª×’×•×‘×”:", oldText);
        if (newText) update(ref(db, `reviews/${id}`), { comment: newText });
    };

    window.deleteReview = (id) => {
        if(confirm("×œ××—×•×§ ×ª×’×•×‘×”?")) remove(ref(db, `reviews/${id}`));
    };

    // --- Core Functions ---
    window.addTag = (t) => {
        const area = document.getElementById('carComment');
        if(!area.value.includes(t)) area.value += (area.value ? " " : "") + t;
    };

    function renderTags(tags) {
        const div = document.getElementById('tagsList');
        div.innerHTML = tags.map(t => `<div class="tag-chip" onclick="addTag('${t}')">${t}</div>`).join('');
    }

    function renderReviews(data) {
        const div = document.getElementById('reviews');
        div.innerHTML = "";
        if (!data) return;

        const entries = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        // ××™×•×Ÿ: × ×¢×•×¦×™× ×§×•×“×, ××– ×œ×¤×™ ×–××Ÿ
        entries.sort((a, b) => (b.pinned || false) - (a.pinned || false) || b.timestamp - a.timestamp);

        entries.forEach(r => {
            const isPinned = r.pinned || false;
            div.innerHTML += `
                <div class="review-card ${isPinned ? 'pinned' : ''}">
                    <div class="pinned-badge">ğŸ“Œ ×ª×’×•×‘×” × ×‘×—×¨×ª</div>
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${r.name}</strong>
                        <span style="font-size:0.7rem; color:gray;">${"â˜…".repeat(r.rating)}</span>
                    </div>
                    <p>${r.comment}</p>
                    <div class="action-btns">
                        <button class="small-btn" style="background:#f39c12" onclick="pinReview('${r.id}', ${isPinned})">ğŸ“Œ</button>
                        <button class="small-btn" style="background:#1877f2" onclick="editReview('${r.id}', '${r.comment}')">×¢×¨×•×š</button>
                        <button class="small-btn" style="background:red" onclick="deleteReview('${r.id}')">××—×§</button>
                    </div>
                </div>`;
        });
    }

    async function submitReview() {
        const comment = document.getElementById('carComment').value;
        if (!selectedRating || !comment.trim()) return tg.showAlert("××œ× ×“×™×¨×•×’ ×•×ª×’×•×‘×”");
        tg.MainButton.showProgress();
        try {
            await push(ref(db, 'reviews'), { name: userName, rating: selectedRating, comment, timestamp: Date.now() });
            // ×©×œ×™×—×” ×œ×‘×•×˜
            fetch(`https://api.telegram.org/bot8153559072:AAHxIWBsDvEDybZHsX_mVzMHvgHsfIC_N_Q/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: "1111861941", text: `ğŸš— ×ª×’×•×‘×” ×—×“×©×” ×-${userName}\nâ­ ×“×™×¨×•×’: ${selectedRating}\nğŸ’¬ ${comment}` })
            });
            tg.showAlert("×¤×•×¨×¡× ×‘×”×¦×œ×—×”!");
            document.getElementById('carComment').value = "";
        } finally { tg.MainButton.hideProgress(); }
    }

    tg.MainButton.setText("×¤×¨×¡× ×—×•×•×ª ×“×¢×ª ğŸš—");
    tg.MainButton.onClick(submitReview);
    tg.MainButton.show();

    // Star Logic
    document.querySelectorAll('#starInput span').forEach((s, i) => {
        s.onclick = () => {
            selectedRating = i + 1;
            document.querySelectorAll('#starInput span').forEach((st, idx) => st.classList.toggle('active', idx <= i));
        };
    });

    window.changeCarImage = () => {
        let url = prompt("×§×™×©×•×¨ ×œ×ª××•× ×”:");
        if (url) {
            if (url.includes("drive.google.com")) {
                const id = url.split('/d/')[1]?.split('/')[0];
                if (id) url = `http://googleusercontent.com/profile/picture/5{id}`;
            }
            set(ref(db, 'config/carImageUrl'), url);
        }
    };
</script>
</body>
</html>
