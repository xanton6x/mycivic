<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Civic Rating - Full Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-secondary-bg-color, #f0f2f5);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #1c1e21);
            --sub-text: var(--tg-theme-hint-color, #65676b);
            --border-color: var(--tg-theme-section-separator-color, #ddd);
            --input-bg: var(--tg-theme-secondary-bg-color, #f5f6f7);
            --star-color: #ccc; --star-active: #f39c12;
            --primary: var(--tg-theme-button-color, #1877f2);
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 20px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px; position: relative; box-sizing: border-box; }
        
        /* ×¤×•×¤-××¤ */
        .ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .ad-modal { background: var(--card-bg); width: 85%; max-width: 320px; padding: 25px; border-radius: 20px; text-align: center; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: slideUp 0.4s ease-out; }
        .close-ad { position: absolute; top: 12px; left: 12px; background: none; border: none; font-size: 20px; color: var(--sub-text); cursor: pointer; }

        .profile-container { position: relative; width: 120px; height: 120px; margin: -60px auto 15px; }
        .car-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 5px solid var(--card-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .change-pic-btn { position: absolute; bottom: 5px; right: 5px; background: #42b72a; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 10; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 15px; align-items: center; margin-bottom: 20px; }
        .average-score { font-size: 3.5rem; font-weight: 800; color: var(--star-active); margin: 0; }
        .dist-bar-container { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-bottom: 4px; }
        .dist-bar-bg { flex: 1; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; }
        .dist-bar-fill { height: 100%; background: var(--star-active); width: 0%; transition: 0.5s; }

        .star-rating { display: flex; justify-content: center; gap: 8px; margin: 15px 0; font-size: 35px; direction: ltr; }
        .star-rating span { color: var(--star-color); cursor: pointer; transition: 0.2s; user-select: none; }
        .star-rating span.active { color: var(--star-active); animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; justify-content: center; }
        .tag-chip { background: var(--input-bg); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; color: var(--text-color); }
        
        textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); box-sizing: border-box; font-size: 16px; outline: none; resize: none; font-family: inherit; }

        .review-card { background: var(--card-bg); padding: 15px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .review-card.pinned { border: 2px solid gold; background: linear-gradient(to bottom, var(--card-bg), var(--input-bg)); }
        .review-header { display: flex; gap: 12px; align-items: center; margin-bottom: 8px; }
        .user-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: var(--input-bg); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }

        .admin-controls { display: flex; gap: 10px; position: absolute; top: -40px; left: 0; }
        .admin-btn { background: var(--card-bg); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .action-btns { display: flex; gap: 8px; margin-top: 10px; display: none; }
        .admin-active .action-btns { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="adOverlay" class="ad-overlay">
    <div class="ad-modal">
        <button class="close-ad" onclick="closeAd()">âœ•</button>
        <h2 style="margin-top:10px; color:var(--primary);">ğŸ“¢ ×¢×“×›×•×Ÿ ×—×©×•×‘</h2>
        <p id="adTextBody" style="margin:15px 0;"></p>
        <button class="ad-action-btn" onclick="openAdLink()" style="background:var(--primary); color:white; border:none; padding:12px; width:100%; border-radius:12px; font-weight:bold; cursor:pointer;">×‘×“×•×§ ×¢×›×©×™×•</button>
    </div>
</div>

<div class="container">
    <div class="admin-controls">
        <button class="admin-btn" onclick="adminLogin()">ğŸ”‘</button>
        <button id="lockBtn" class="admin-btn" style="display:none;" onclick="toggleLock()">ğŸ”“</button>
        <button id="adBtn" class="admin-btn" style="display:none;" onclick="editAd()">ğŸ“¢</button>
    </div>

    <div class="profile-container">
        <img id="carImage" src="https://via.placeholder.com/150" class="car-pic">
        <button id="changePicBtn" class="change-pic-btn" onclick="changeCarImage()">ğŸ“·</button>
    </div>

    <div id="lockMessage" style="display:none; text-align:center; color:#ff4d4d; font-weight:bold; margin-bottom:15px; font-size: 0.9rem;">ğŸ”’ ×”×“×™×¨×•×’ ×¡×’×•×¨ ×›×¨×’×¢.</div>

    <div class="stats-grid">
        <div style="text-align: center;">
            <p class="average-score" id="avgScore">0.0</p>
            <div id="avgStars" style="color:var(--star-active); font-size: 14px;"></div>
            <p id="totalReviews" style="font-size:0.75rem; color:var(--sub-text); margin-top: 4px;"></p>
        </div>
        <div id="distribution"></div>
    </div>

    <div id="inputArea">
        <div id="welcomeMsg" style="text-align:center; font-weight:bold; margin-bottom:5px; font-size: 0.9rem;"></div>
        <div class="star-rating" id="starInput">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <div class="tags-container" id="tagsList"></div>
        <button id="editTagsBtn" style="display:none; background:none; border:none; color:var(--sub-text); cursor:pointer; font-size: 0.75rem; margin: -5px auto 10px; text-decoration: underline;" onclick="editTags()">âœï¸ ×¢×¨×•×š ×ª×’×™×•×ª</button>
        <textarea id="carComment" rows="3" placeholder="×›×ª×•×‘ ×—×•×•×ª ×“×¢×ª..."></textarea>
    </div>
</div>

<div id="reviews" style="width:100%; max-width:500px; margin-top:25px;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCiBOPWWSgKlz0IHVvTt4jktfHLI1hsYQc",
        authDomain: "mycivic-11af8.firebaseapp.com",
        databaseURL: "https://mycivic-11af8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mycivic-11af8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    let isAdmin = false, selectedRating = 0, isLocked = false, adLink = "", hasShownAd = false, currentReviewsData = null;
    const user = tg.initDataUnsafe?.user;
    const userName = user ? `${user.first_name} ${user.last_name || ""}` : "××•×¨×—";
    const userPhoto = user?.photo_url || null;

    document.getElementById('welcomeMsg').innerText = `×”×™×™ ${userName}, ×“×¨×’ ××•×ª×™:`;

    // --- Helper Functions ---
    function timeAgo(ts) {
        if (!ts) return "×¢×›×©×™×•";
        const mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 1) return "×¢×›×©×™×•";
        if (mins < 60) return `×œ×¤× ×™ ${mins} ×“×§'`;
        if (mins < 1440) return `×œ×¤× ×™ ${Math.floor(mins/60)} ×©×¢'`;
        return `×œ×¤× ×™ ${Math.floor(mins/1440)} ×™××™×`;
    }

    function getAvatarColor(name) {
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#4caf50'];
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return colors[Math.abs(hash) % colors.length];
    }

    // --- Listeners ---
    onValue(ref(db, 'reviews'), (s) => { currentReviewsData = s.val(); renderReviews(currentReviewsData); });
    onValue(ref(db, 'config'), (s) => {
        const conf = s.val() || {};
        if (conf.carImageUrl) document.getElementById('carImage').src = conf.carImageUrl;
        isLocked = conf.isLocked || false;
        handleLockUI();
        renderTags(conf.tags || ['ğŸš€ ××˜×•×¡!', 'ğŸ”¥ ×”×¦×’×”', 'ğŸ”Š ×¡××•× ×“', 'ğŸ’ ×©××•×¨×”']);
        
        if(conf.adText && !hasShownAd) {
            document.getElementById('adTextBody').innerText = conf.adText;
            document.getElementById('adOverlay').style.display = 'flex';
            adLink = conf.adLink || "";
            hasShownAd = true;
        }
    });

    function handleLockUI() {
        document.getElementById('lockBtn').innerText = isLocked ? "ğŸ”’" : "ğŸ”“";
        document.getElementById('lockMessage').style.display = isLocked ? "block" : "none";
        document.getElementById('inputArea').style.opacity = isLocked ? "0.3" : "1";
        document.getElementById('inputArea').style.pointerEvents = isLocked ? "none" : "all";
        isLocked ? tg.MainButton.hide() : tg.MainButton.show();
    }

    function renderReviews(data) {
        const div = document.getElementById('reviews');
        div.innerHTML = "";
        if (!data) return;
        const entries = Object.entries(data).map(([id, val]) => ({ id, ...val }));
        entries.sort((a, b) => (b.pinned || false) - (a.pinned || false) || b.timestamp - a.timestamp);

        entries.forEach(r => {
            const isPinned = r.pinned || false;
            const avatar = r.photo_url 
                ? `<img src="${r.photo_url}" class="user-avatar">` 
                : `<div class="user-avatar" style="background:${getAvatarColor(r.name)}">${r.name.charAt(0)}</div>`;

            div.innerHTML += `
                <div class="review-card ${isPinned ? 'pinned' : ''}">
                    <div class="review-header">
                        ${avatar}
                        <div style="flex-grow:1;">
                            <strong>${r.name}</strong>
                            <div style="color:var(--star-active); font-size:10px;">${"â˜…".repeat(r.rating)}</div>
                        </div>
                        <span style="font-size:0.7rem; color:var(--sub-text);">${timeAgo(r.timestamp)}</span>
                    </div>
                    <p style="margin: 5px 0 0 0; font-size: 0.95rem;">${r.comment}</p>
                    <div class="action-btns">
                        <button class="small-btn" style="background:#f39c12; border:none; padding:5px 10px; border-radius:8px; color:white;" onclick="pinReview('${r.id}', ${isPinned})">ğŸ“Œ</button>
                        <button class="small-btn" style="background:red; border:none; padding:5px 10px; border-radius:8px; color:white;" onclick="deleteReview('${r.id}')">××—×§</button>
                    </div>
                </div>`;
        });
        updateStats(entries);
    }

    function updateStats(entries) {
        let sum = 0, count = entries.length, dist = {1:0, 2:0, 3:0, 4:0, 5:0};
        entries.forEach(r => { sum += r.rating; dist[r.rating]++; });
        const avg = count ? (sum/count).toFixed(1) : "0.0";
        document.getElementById('avgScore').innerText = avg;
        document.getElementById('avgStars').innerHTML = "â˜…".repeat(Math.round(avg));
        document.getElementById('totalReviews').innerText = `${count} ×—×•×•×ª ×“×¢×ª`;
        let dHtml = "";
        for(let i=5; i>=1; i--) {
            const pct = count ? (dist[i]/count)*100 : 0;
            dHtml += `<div class="dist-bar-container"><span>${i}</span><div class="dist-bar-bg"><div class="dist-bar-fill" style="width:${pct}%"></div></div></div>`;
        }
        document.getElementById('distribution').innerHTML = dHtml;
    }

    async function submitReview() {
        const comment = document.getElementById('carComment').value;
        if (!selectedRating || !comment.trim()) { tg.HapticFeedback.notificationOccurred('error'); return tg.showAlert("×‘×—×¨ ×“×™×¨×•×’ ×•×›×ª×•×‘ ×ª×’×•×‘×”"); }
        tg.MainButton.showProgress();
        try {
            await push(ref(db, 'reviews'), { name: userName, rating: selectedRating, comment, timestamp: Date.now(), photo_url: userPhoto });
            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('carComment').value = "";
            selectedRating = 0;
            document.querySelectorAll('#starInput span').forEach(s => s.classList.remove('active'));
            tg.showAlert("×ª×•×“×”! ×”×“×™×¨×•×’ ×¤×•×¨×¡×.");
        } finally { tg.MainButton.hideProgress(); }
    }

    // --- Admin Functions ---
    window.adminLogin = () => {
        if(prompt("×¡×™×¡××”:") === "1234") {
            isAdmin = true;
            document.body.classList.add('admin-active');
            document.getElementById('changePicBtn').style.display = 'flex';
            document.getElementById('lockBtn').style.display = 'block';
            document.getElementById('adBtn').style.display = 'block';
            document.getElementById('editTagsBtn').style.display = 'block';
            renderReviews(currentReviewsData);
            tg.HapticFeedback.impactOccurred('medium');
        }
    };
    window.editAd = () => {
        const text = prompt("×˜×§×¡×˜ ×œ×¤×•×¤-××¤ (×¨×™×§ ×œ×‘×™×˜×•×œ):");
        const link = text ? prompt("×§×™×©×•×¨ ×œ×œ×—×™×¦×”:") : "";
        update(ref(db, 'config'), { adText: text, adLink: link });
    };
    window.closeAd = () => document.getElementById('adOverlay').style.display = 'none';
    window.openAdLink = () => { if(adLink) { tg.openLink(adLink); closeAd(); } };
    window.toggleLock = () => set(ref(db, 'config/isLocked'), !isLocked);
    window.editTags = () => {
        const t = prompt("×ª×’×™×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§):");
        if(t) set(ref(db, 'config/tags'), t.split(',').map(x => x.trim()));
    };
    window.pinReview = (id, s) => update(ref(db, `reviews/${id}`), { pinned: !s });
    window.deleteReview = (id) => { if(confirm("×œ××—×•×§?")) remove(ref(db, `reviews/${id}`)); };
    window.changeCarImage = () => { const u = prompt("URL ×ª××•× ×”:"); if(u) set(ref(db, 'config/carImageUrl'), u); };
    function renderTags(tags) { document.getElementById('tagsList').innerHTML = tags.map(t => `<div class="tag-chip" onclick="addTag('${t}')">${t}</div>`).join(''); }
    window.addTag = (t) => { tg.HapticFeedback.impactOccurred('light'); const a = document.getElementById('carComment'); if(!a.value.includes(t)) a.value += (a.value ? " " : "") + t; };

    tg.MainButton.setText("×¤×¨×¡× ×—×•×•×ª ×“×¢×ª ğŸš—");
    tg.MainButton.onClick(submitReview);
    tg.MainButton.show();
    document.querySelectorAll('#starInput span').forEach((s, i) => {
        s.onclick = () => {
            selectedRating = i + 1;
            document.querySelectorAll('#starInput span').forEach((st, idx) => st.classList.toggle('active', idx <= i));
            tg.HapticFeedback.impactOccurred('light');
        };
    });
</script>
</body>
</html>
