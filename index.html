<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×™×¨×•×’ ×”-Civic ×©×œ×™</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #1c1e21;
            --sub-text: #65676b; --border-color: #ddd; --input-bg: #fff;
        }
        [data-theme="dark"] {
            --bg-color: #18191a; --card-bg: #242526; --text-color: #e4e6eb;
            --sub-text: #b0b3b8; --border-color: #3e4042; --input-bg: #3a3b3c;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); text-align: center; padding: 20px; color: var(--text-color); transition: 0.3s; }
        .container { max-width: 600px; margin: auto; background: var(--card-bg); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        
        .profile-pic-container { position: relative; width: 150px; height: 150px; margin: 0 auto 20px; }
        .car-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #1877f2; background: #eee; }
        
        .change-pic-btn { position: absolute; bottom: 5px; right: 5px; background: #42b72a; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: none; font-size: 20px; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .stats-box { background: var(--bg-color); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .average-score { font-size: 2.5rem; font-weight: bold; color: #f39c12; margin: 0; }
        .rating-input { margin: 20px 0; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); font-size: 16px; }
        button { background: #1877f2; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-weight: bold; width: 100%; }
        
        .theme-toggle, .admin-toggle { position: fixed; top: 20px; background: #1877f2; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; width: 45px; height: 45px; font-size: 20px; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .theme-toggle { left: 20px; }
        .admin-toggle { left: 75px; background: #42b72a; }
        
        #reviews { margin-top: 30px; text-align: right; }
        .review-card { border-bottom: 1px solid var(--border-color); padding: 15px 0; position: relative; }
        .stars { color: #f39c12; }
        
        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ××—×™×§×” ×œ×× ×”×œ */
        .del-btn { 
            background: #ff4d4d; color: white; border: none; 
            padding: 5px 10px; border-radius: 6px; cursor: pointer; 
            float: left; font-size: 12px; font-weight: bold;
        }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
<button class="admin-toggle" onclick="adminLogin()">ğŸ”‘</button>

<div class="container">
    <h1>×“×™×¨×•×’ ×”-Civic ×©×œ×™</h1>
    
    <div class="profile-pic-container">
        <img id="carImage" src="https://via.placeholder.com/150?text=Car" class="car-pic" alt="My Car">
        <button id="changePicBtn" class="change-pic-btn" onclick="changeCarImage()">ğŸ“·</button>
    </div>

    <div class="stats-box">
        <p class="average-score" id="avgScore">0.0</p>
        <div id="avgStars" class="stars"></div>
        <p id="totalReviews" style="font-size: 0.9rem; color: var(--sub-text);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
    </div>

    <div class="rating-input">
        <input type="text" id="reviewerName" placeholder="×”×©× ×©×œ×›×">
        <select id="carRating">
            <option value="5">â­â­â­â­â­ (××¢×•×œ×”)</option>
            <option value="4">â­â­â­â­ (×˜×•×‘ ×××“)</option>
            <option value="3">â­â­â­ (× ×—××“)</option>
            <option value="2">â­â­ (×˜×¢×•×Ÿ ×©×™×¤×•×¨)</option>
            <option value="1">â­ (×œ× ××”×‘×ª×™)</option>
        </select>
        <textarea id="carComment" placeholder="×›×ª×‘×• ×—×•×•×ª ×“×¢×ª..."></textarea>
        <button onclick="submitReview()">×©×œ×— ×“×™×¨×•×’</button>
    </div>

    <hr>
    <div id="reviews"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCiBOPWWSgKlz0IHVvTt4jktfHLI1hsYQc",
    authDomain: "mycivic-11af8.firebaseapp.com",
    databaseURL: "https://mycivic-11af8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mycivic-11af8",
    storageBucket: "mycivic-11af8.appspot.com", 
    messagingSenderId: "428340353040",
    appId: "1:428340353040:web:f6f9f9ce2c83c8ed195295"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const reviewsRef = ref(db, 'reviews');

  let isAdmin = false;
  let currentReviewsData = null; // ×©××™×¨×ª ×”× ×ª×•× ×™× ×’×œ×•×‘×œ×™×ª ×›×“×™ ×œ×¨×¢× ×Ÿ ×ª×¦×•×’×” ×‘×§×œ×•×ª

  // ×˜×¢×™× ×ª ×”×ª××•× ×”
  onValue(ref(db, 'config/carImageUrl'), (snapshot) => {
      const url = snapshot.val();
      if (url) document.getElementById('carImage').src = url;
  });

  // ×›× ×™×¡×ª ×× ×”×œ
  window.adminLogin = () => {
      const user = prompt("×©× ××©×ª××©:");
      const pass = prompt("×¡×™×¡××”:");
      if (user === "admin" && pass === "Qtoha1394") {
          isAdmin = true;
          document.getElementById('changePicBtn').style.display = 'flex';
          alert("××—×•×‘×¨ ×›×× ×”×œ! ×›×¤×ª×•×¨×™ ××—×™×§×” ××•×¤×¢×œ×™×.");
          renderReviews(currentReviewsData); // ×¨×¢× ×•×Ÿ ××™×™×“×™ ×©×œ ×”×ª×’×•×‘×•×ª ×œ×”×¦×’×ª ×›×¤×ª×•×¨×™ ××—×™×§×”
      } else {
          alert("×¤×¨×˜×™× ×©×’×•×™×™×");
      }
  };

  window.changeCarImage = () => {
      let url = prompt("×”×“×‘×§ ×›××Ÿ ××ª ×§×™×©×•×¨ ×”×©×™×ª×•×£ ×©×œ ×”×ª××•× ×” ×-Google Drive:");
      if (url) {
          if (url.includes("drive.google.com")) {
              try {
                  const parts = url.split('/');
                  const fileId = parts[parts.indexOf('d') + 1];
                  url = `https://lh3.googleusercontent.com/u/0/d/${fileId}`;
              } catch (e) { alert("×œ×™× ×§ ×œ× ×ª×§×™×Ÿ"); return; }
          }
          set(ref(db, 'config/carImageUrl'), url).then(() => alert("×¢×•×“×›×Ÿ!"));
      }
  };

  window.submitReview = () => {
    const name = document.getElementById('reviewerName').value || "××•×¨×—";
    const rating = document.getElementById('carRating').value;
    const comment = document.getElementById('carComment').value;
    if (!comment.trim()) return alert("×›×ª×‘×• ×—×•×•×ª ×“×¢×ª");
    push(reviewsRef, { name, rating: parseInt(rating), comment, timestamp: Date.now() });
    document.getElementById('carComment').value = "";
    document.getElementById('reviewerName').value = "";
  };

  // ×¤×•× ×§×¦×™×™×ª ×”××—×™×§×”
  window.deleteReview = (id) => {
      if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×’×•×‘×” ×–×•?")) {
          remove(ref(db, 'reviews/' + id))
            .then(() => alert("×”×ª×’×•×‘×” × ××—×§×”"))
            .catch((err) => alert("×©×’×™××” ×‘××—×™×§×”: " + err));
      }
  };

  // ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘-Database
  onValue(reviewsRef, (snapshot) => {
    currentReviewsData = snapshot.val();
    renderReviews(currentReviewsData);
  });

  function renderReviews(data) {
    const reviewsDiv = document.getElementById('reviews');
    reviewsDiv.innerHTML = "<h3>×—×•×•×ª ×“×¢×ª ××”×’×•×œ×©×™×:</h3>";
    
    if (!data) {
        document.getElementById('totalReviews').innerText = "××™×Ÿ ×“×™×¨×•×’×™× ×¢×“×™×™×Ÿ";
        document.getElementById('avgScore').innerText = "0.0";
        document.getElementById('avgStars').innerHTML = "";
        return;
    }

    let totalScore = 0, count = 0;
    const sortedKeys = Object.keys(data).reverse();

    sortedKeys.forEach(id => {
      const r = data[id];
      totalScore += r.rating;
      count++;
      const date = new Date(r.timestamp).toLocaleDateString('he-IL');
      
      reviewsDiv.innerHTML += `
        <div class="review-card">
            ${isAdmin ? `<button class="del-btn" onclick="deleteReview('${id}')">××—×§ ğŸ—‘ï¸</button>` : ''}
            <strong>${r.name}</strong>
            <div class="stars">${"â­".repeat(r.rating)}</div>
            <p>${r.comment}</p>
            <small style="color:var(--sub-text)">${date}</small>
        </div>`;
    });

    const avg = (totalScore / count).toFixed(1);
    document.getElementById('avgScore').innerText = avg;
    document.getElementById('avgStars').innerHTML = "â­".repeat(Math.round(avg));
    document.getElementById('totalReviews').innerText = `××‘×•×¡×¡ ×¢×œ ${count} ×“×™×¨×•×’×™×`;
  }

  window.toggleTheme = () => {
      const target = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", target);
      localStorage.setItem("theme", target);
      document.getElementById("themeBtn").innerText = target === "dark" ? "â˜€ï¸" : "ğŸŒ™";
  };
  if (localStorage.getItem("theme") === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
      document.getElementById("themeBtn").innerText = "â˜€ï¸";
  }
</script>

</body>
</html>
